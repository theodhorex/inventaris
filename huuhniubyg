package org.week11;

import javafx.application.Platform;
import javafx.beans.value.ChangeListener;
import javafx.beans.value.ObservableValue;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;

import java.io.IOException;
import java.net.URL;
import java.sql.*;
import java.util.ResourceBundle;
import java.util.function.Predicate;

public class DaftarCatatanController implements Initializable {
    public Button btnGrafik;
    @FXML private TextField txtFldJudul;
    @FXML private TextArea txtAreaKonten;
    @FXML private TextField searchBox;
    @FXML private Button btnClearSearch;
    @FXML private TableView<Catatan> table;
    @FXML private TableColumn<Catatan, String> id;
    @FXML private TableColumn<Catatan, String> judul;
    @FXML private TableColumn<Catatan, String> kategori;
    @FXML private ChoiceBox<String> cbKategori;

    private final String DB_URL = "jdbc:sqlite:catatanku.db";
    private Connection connection;
    private ObservableList<Catatan> catatanObservableList;
    private FilteredList<Catatan> filteredList;
    private Catatan selectedCatatan;

    @Override
    public void initialize(URL location, ResourceBundle resources) {
        catatanObservableList = FXCollections.observableArrayList();
        filteredList = new FilteredList<>(catatanObservableList, p -> true);
        table.setItems(filteredList);

        id.setCellValueFactory(new PropertyValueFactory<>("id"));
        judul.setCellValueFactory(new PropertyValueFactory<>("judul"));
        kategori.setCellValueFactory(new PropertyValueFactory<>("kategori"));

        getConnection();
        createTable();
        getAllData();

        table.getSelectionModel().selectedItemProperty().addListener(new ChangeListener<Catatan>() {
            @Override
            public void changed(ObservableValue<? extends Catatan> obs, Catatan oldVal, Catatan newVal) {
                if (newVal != null) {
                    selectedCatatan = newVal;
                    txtFldJudul.setText(newVal.getJudul());
                    txtAreaKonten.setText(newVal.getKonten());
                    cbKategori.setValue(newVal.getKategori());
                }
            }
        });

        cbKategori.getItems().addAll(
                Catatan.CATATAN_SELF_DEVELOPEMENT,
                Catatan.CATATAN_BELANJA,
                Catatan.CATATAN_KHUSUS,
                Catatan.CATATAN_PERCINTAAN
        );

        searchBox.textProperty().addListener((obs, oldVal, newVal) -> {
            filteredList.setPredicate(createPredicate(newVal));
        });

        bersihkan();
    }

    @FXML
    protected void onBtnClearSearch() {
        searchBox.clear();
        bersihkan();
        filteredList.setPredicate(p -> true);
    }

    private Connection getConnection() {
        if (connection == null) {
            try {
                connection = DriverManager.getConnection(DB_URL);
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
        return connection;
    }

    public void closeConnection() {
        if (connection != null) {
            try {
                connection.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }

    private void createTable() {
        String sql = """
            CREATE TABLE IF NOT EXISTS catatan (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                judul TEXT NOT NULL,
                konten TEXT NOT NULL,
                kategori TEXT NOT NULL
            )
        """;
        try (Statement stmt = connection.createStatement()) {
            stmt.execute(sql);
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private Predicate<Catatan> createPredicate(String searchText) {
        return catatan -> {
            if (searchText == null || searchText.isEmpty()) return true;
            return searchFindsCatatan(catatan, searchText);
        };
    }

    private boolean searchFindsCatatan(Catatan catatan, String searchText) {
        String lower = searchText.toLowerCase();
        return catatan.getJudul().toLowerCase().contains(lower) ||
                catatan.getKonten().toLowerCase().contains(lower) ||
                catatan.getKategori().toLowerCase().contains(lower);
    }

    private void getAllData() {
        String query = "SELECT * FROM catatan";
        catatanObservableList.clear();
        try (PreparedStatement preparedStatement = connection.prepareStatement(query)) {
            ResultSet rs = preparedStatement.executeQuery();
            while (rs.next()) {
                Catatan c = new Catatan(
                        rs.getInt("id"),
                        rs.getString("judul"),
                        rs.getString("konten"),
                        rs.getString("kategori")
                );
                catatanObservableList.add(c);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void bersihkan() {
        txtFldJudul.clear();
        txtAreaKonten.clear();
        txtFldJudul.requestFocus();
        table.getSelectionModel().clearSelection();
        selectedCatatan = null;
        cbKategori.getSelectionModel().clearSelection();
        cbKategori.getSelectionModel().selectFirst();
    }

    private boolean isCatatanUpdated() {
        if (selectedCatatan == null) return false;
        return !selectedCatatan.getJudul().equalsIgnoreCase(txtFldJudul.getText()) ||
                !selectedCatatan.getKonten().equalsIgnoreCase(txtAreaKonten.getText()) ||
                !selectedCatatan.getKategori().equalsIgnoreCase(cbKategori.getValue());
    }

    @FXML
    protected void onBtnSimpanClick() {
        if (isCatatanUpdated()) {
            Catatan updated = new Catatan(
                    selectedCatatan.getId(),
                    txtFldJudul.getText(),
                    txtAreaKonten.getText(),
                    cbKategori.getValue()
            );
            if (updateCatatan(selectedCatatan, updated)) {
                showAlert(Alert.AlertType.INFORMATION, "Catatan Dirubah!");
            } else {
                showAlert(Alert.AlertType.ERROR, "Catatan gagal Dirubah!");
            }
        } else {
            Catatan newCatatan = new Catatan(
                    txtFldJudul.getText(),
                    txtAreaKonten.getText(),
                    cbKategori.getValue()
            );
            if (addCatatan(newCatatan)) {
                showAlert(Alert.AlertType.INFORMATION, "Catatan Ditambahkan!");
            } else {
                showAlert(Alert.AlertType.ERROR, "Catatan gagal Ditambahkan!");
            }
        }
        bersihkan();
    }

    @FXML
    protected void onBtnHapus() {
        if (selectedCatatan != null && deleteCatatan(selectedCatatan)) {
            showAlert(Alert.AlertType.INFORMATION, "Catatan Dihapus!");
            bersihkan();
        }
    }

    private boolean deleteCatatan(Catatan catatan) {
        String query = "DELETE FROM catatan WHERE id = ?";
        try (PreparedStatement stmt = connection.prepareStatement(query)) {
            stmt.setInt(1, catatan.getId());
            int rows = stmt.executeUpdate();
            if (rows > 0) {
                catatanObservableList.remove(catatan);
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    private boolean addCatatan(Catatan catatan) {
        String query = "INSERT INTO catatan (judul, konten, kategori) VALUES (?, ?, ?)";
        try (PreparedStatement stmt = connection.prepareStatement(query, Statement.RETURN_GENERATED_KEYS)) {
            stmt.setString(1, catatan.getJudul());
            stmt.setString(2, catatan.getKonten());
            stmt.setString(3, catatan.getKategori());
            int rows = stmt.executeUpdate();
            if (rows > 0) {
                ResultSet rs = stmt.getGeneratedKeys();
                if (rs.next()) {
                    catatan.setId(rs.getInt(1));
                }
                catatanObservableList.add(catatan);
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    private boolean updateCatatan(Catatan oldCatatan, Catatan newCatatan) {
        String query = "UPDATE catatan SET judul = ?, konten = ?, kategori = ? WHERE id = ?";
        try (PreparedStatement stmt = connection.prepareStatement(query)) {
            stmt.setString(1, newCatatan.getJudul());
            stmt.setString(2, newCatatan.getKonten());
            stmt.setString(3, newCatatan.getKategori());
            stmt.setInt(4, oldCatatan.getId());
            int rows = stmt.executeUpdate();
            if (rows > 0) {
                int index = catatanObservableList.indexOf(oldCatatan);
                catatanObservableList.set(index, newCatatan);
                return true;
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    @FXML
    protected void onMenuGrafikClicked(ActionEvent event) {
        try {
            Apps.openViewWithModal("grafik-view", false);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @FXML
    protected void onBtnCloseClick() {
        Platform.exit();
    }

    private void showAlert(Alert.AlertType type, String message) {
        new Alert(type, message).show();
    }
}
